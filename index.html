<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lista Spesa</title>
  <meta name="theme-color" content="#111827" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel for JSX in-browser -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-neutral-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const STORAGE_KEY = "mylos-shopping-list-v1-static";

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const categories = [
      { id: "carne", label: "Carne & Affettati", emoji: "ðŸ¥©" },
      { id: "pesce", label: "Pesce & Mare", emoji: "ðŸŸ" },
      { id: "latticini", label: "Latticini & Formaggi", emoji: "ðŸ¥›" },
      { id: "orto", label: "Ortofrutta & Verdure", emoji: "ðŸ¥¦" },
      { id: "frutta_secca", label: "Frutta secca & Derivati", emoji: "ðŸŒ°" },
      { id: "legumi", label: "Legumi & Vegetali proteici", emoji: "ðŸŒ±" },
      { id: "cereali", label: "Cereali, Pane & Derivati", emoji: "ðŸŒ¾" },
      { id: "farine", label: "Farine & Preparati", emoji: "ðŸ¥£" },
      { id: "condimenti", label: "Condimenti & Salse", emoji: "ðŸ¯" },
      { id: "dolci", label: "Dolci & Snack", emoji: "ðŸ«" },
      { id: "uova", label: "Uova & Derivati", emoji: "ðŸ¥š" },
      { id: "vari", label: "Vari", emoji: "ðŸ§‚" },
    ];

    const defaultData = {
      carne: [
        "Affettato magro (pollo, tacchino, manzo)",
        "Affettato semigrasso (prosciutto crudo, cotto, speck)",
        "Bresaola",
        "Carne rossa magra",
        "Filetto di carne rossa",
        "Filetto di pollo",
        "Filetto di tacchino",
        "Macinato magro",
        "Pollo, tacchino, bresaola, manzo",
        "Tacchino",
      ],
      pesce: [
        "Calamari",
        "Cozze",
        "Filetti di pesce bianco",
        "Filetto di sgombro in olio sgocc.",
        "Filetto di tonno in olio sgocc.",
        "Gamberi",
        "Molluschi o crostacei (seppia, polpo, calamaro, gamberi)",
        "Merluzzo",
        "Nasello",
        "Pesce azzurro (alici, sardine, sgombro, palamita)",
        "Pesce spada",
        "Polpo",
        "Pescatrice",
        "Salmone selvaggio affumicato",
        "Salmone selvaggio surgelato",
        "Seppia",
        "Sogliola",
        "Tonno fresco o in scatola al naturale",
        "Trancio di spada",
        "Trancio di tonno",
      ],
      latticini: [
        "Crescenza",
        "Feta classica",
        "Feta light Zorbas",
        "Fiocchi di latte light",
        "Fiocchi di latte light ~0 grassi",
        "Formaggi duri (parmigiano, grana)",
        "Mozzarella proteica GRANAROLO Hi-Protein",
        "Mozzarella proteica o light",
        "Philadelphia Active/Protein+",
        "Primosale",
        "Ricotta classica o light",
        "Stracchino light",
        "Yogurt greco bianco magro",
      ],
      orto: [
        "Avocado",
        "Broccoli",
        "Carote",
        "Finocchi",
        "Funghi",
        "Limone",
        "Meloncelle",
        "Pomodorini",
        "Sedano",
        "Spinaci",
        "Verdure grigliate",
        "Zucchine",
      ],
      frutta_secca: [
        "Frutta secca (noci, mandorle, nocciole)",
        "Burro d'arachidi",
        "Crema di nocciole",
      ],
      legumi: [
        "Burger o polpette o straccetti soia",
        "Edamame",
        "Legumi secchi o in barattolo (ceci, fagioli, lenticchie, piselli)",
        "Pasta di legumi (piselli, ceci, lenticchie, lupini)",
        "Tempeh",
        "Tofu / edamame",
      ],
      cereali: [
        "Cereali in chicchi",
        "Crostini sottili integrali",
        "Farro",
        "Orzo",
        "Pane integrale",
        "Pane di segale",
        "Pasta (integrale, avena, grano saraceno)",
        "Piadina integrale",
        "Quinoa",
        "Riso integrale o venere",
      ],
      farine: [
        "Farina d'avena",
        "Farina di ceci",
        "Farina di cocco degrassata",
        "Farina di farro",
        "Farina di lupini",
        "Farina integrale",
        "Farina tipo 1-2",
        "Gnocchi di patate o spinaci",
        "Tortellini freschi ripieni",
      ],
      condimenti: [
        "Maionese",
        "Marmellata",
        "Miele",
        "Olive",
        "Pesto",
        "Dolcificanti ipocalorici",
        "Idrolitina (lievito alternativo per pancake)",
      ],
      dolci: ["Cioccolato fondente"],
      uova: ["Albume d'uovo", "Uova intere"],
      vari: [],
    };

    function buildDefaultItems() {
      const items = [];
      Object.entries(defaultData).forEach(([cat, list]) => {
        list.forEach((name) => {
          items.push({ id: uid(), name, category: cat, checked: false, qty: 1, note: "" });
        });
      });
      return items;
    }

    function App() {
      const [items, setItems] = useState(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) return JSON.parse(raw);
        } catch {}
        return buildDefaultItems();
      });
      const [query, setQuery] = useState("");
      const [showOnlyOpen, setShowOnlyOpen] = useState(false);
      const [collapsed, setCollapsed] = useState({});
      const [newItem, setNewItem] = useState({ name: "", category: "orto" });

      useEffect(() => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        } catch {}
      }, [items]);

      const stats = useMemo(() => {
        const total = items.length;
        const done = items.filter((i) => i.checked).length;
        return { total, done, left: total - done };
      }, [items]);

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        return items.filter((i) => {
          const matchQ = q ? i.name.toLowerCase().includes(q) : true;
          const matchOpen = showOnlyOpen ? !i.checked : true;
          return matchQ && matchOpen;
        });
      }, [items, query, showOnlyOpen]);

      const grouped = useMemo(() => {
        const map = new Map();
        categories.forEach((c) => map.set(c.id, []));
        filtered.forEach((i) => {
          if (!map.has(i.category)) map.set(i.category, []);
          map.get(i.category).push(i);
        });
        return map;
      }, [filtered]);

      function toggleItem(id) {
        setItems((prev) => prev.map((i) => (i.id === id ? { ...i, checked: !i.checked } : i)));
      }
      function updateQty(id, delta) {
        setItems((prev) =>
          prev.map((i) => (i.id === id ? { ...i, qty: Math.max(1, (i.qty || 1) + delta) } : i))
        );
      }
      function updateNote(id, note) {
        setItems((prev) => prev.map((i) => (i.id === id ? { ...i, note } : i)));
      }
      function addItem(e) {
        e.preventDefault();
        const name = newItem.name.trim();
        if (!name) return;
        setItems((prev) => [{ id: uid(), name, category: newItem.category, checked: false, qty: 1, note: "" }, ...prev]);
        setNewItem({ name: "", category: newItem.category });
      }
      function removeChecked() {
        setItems((prev) => prev.filter((i) => !i.checked));
      }
      function resetList() {
        if (!confirm("Ripristinare la lista predefinita?")) return;
        setItems(buildDefaultItems());
        setQuery("");
        setShowOnlyOpen(false);
        setCollapsed({});
      }
      function exportJSON() {
        const blob = new Blob([JSON.stringify(items)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lista-spesa.json";
        a.click();
        URL.revokeObjectURL(url);
      }
      function importJSON(evt) {
        const file = evt.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result));
            if (Array.isArray(data)) setItems(data);
          } catch {}
        };
        reader.readAsText(file);
        evt.target.value = "";
      }
      function toggleCategory(catId) {
        setCollapsed((prev) => ({ ...prev, [catId]: !prev[catId] }));
      }
      function checkAllInCategory(catId, checked) {
        setItems((prev) => prev.map((i) => (i.category === catId ? { ...i, checked } : i)));
      }

      return (
        <div className="min-h-screen bg-neutral-50 pb-28">
          <header className="sticky top-0 z-20 backdrop-blur bg-white/80 border-b border-neutral-200">
            <div className="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
              <span className="text-2xl">ðŸ›’</span>
              <h1 className="text-xl font-semibold">Lista Spesa</h1>
              <span className="ml-auto text-sm text-neutral-600">
                {stats.done}/{stats.total} presi
              </span>
            </div>
            <div className="max-w-3xl mx-auto px-4 pb-3">
              <div className="flex gap-2 items-center">
                <div className="flex-1 relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">ðŸ”Ž</span>
                  <input
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    placeholder="Cerca prodottoâ€¦"
                    className="w-full pl-9 pr-3 py-2 rounded-xl border border-neutral-300 focus:outline-none focus:ring-2 focus:ring-neutral-800 bg-white"
                  />
                </div>
                <label className="flex items-center gap-2 text-sm px-3 py-2 rounded-xl border bg-white">
                  <input type="checkbox" checked={showOnlyOpen} onChange={(e) => setShowOnlyOpen(e.target.checked)} />
                  Solo da prendere
                </label>
              </div>
              <form onSubmit={addItem} className="mt-3 flex gap-2">
                <input
                  value={newItem.name}
                  onChange={(e) => setNewItem((s) => ({ ...s, name: e.target.value }))}
                  placeholder="Aggiungi prodottoâ€¦"
                  className="flex-1 px-3 py-2 rounded-xl border border-neutral-300 focus:outline-none bg-white"
                />
                <select
                  value={newItem.category}
                  onChange={(e) => setNewItem((s) => ({ ...s, category: e.target.value }))}
                  className="px-3 py-2 rounded-xl border bg-white"
                >
                  {categories.map((c) => (
                    <option key={c.id} value={c.id}>
                      {c.emoji} {c.label}
                    </option>
                  ))}
                </select>
                <button type="submit" className="px-3 py-2 rounded-xl border bg-black text-white">
                  Aggiungi
                </button>
              </form>
              <div className="mt-3 flex gap-2 text-sm">
                <button onClick={removeChecked} className="px-3 py-2 rounded-xl border bg-white">Rimuovi presi</button>
                <button onClick={resetList} className="px-3 py-2 rounded-xl border bg-white">Ripristina</button>
                <button onClick={exportJSON} className="px-3 py-2 rounded-xl border bg-white">Esporta</button>
                <label className="px-3 py-2 rounded-xl border bg-white cursor-pointer">
                  Importa <input type="file" accept="application/json" onChange={importJSON} className="hidden" />
                </label>
              </div>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-4 pt-4">
            {categories.map((cat) => {
              const list = grouped.get(cat.id) || [];
              const openCount = list.filter((i) => !i.checked).length;
              const isEmptyByFilter = list.length === 0;
              return (
                <section key={cat.id} className="mb-3">
                  <button
                    onClick={() => toggleCategory(cat.id)}
                    className="w-full flex items-center justify-between bg-white border rounded-2xl px-4 py-3 shadow-sm"
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-xl">{cat.emoji}</span>
                      <h2 className="font-semibold">{cat.label}</h2>
                      <span className="text-xs text-neutral-500 ml-2">{openCount} da prendere</span>
                    </div>
                    <div className="flex items-center gap-2 text-sm">
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          checkAllInCategory(cat.id, true);
                        }}
                        className="px-2 py-1 rounded-lg border"
                      >
                        spunta tutti
                      </button>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          checkAllInCategory(cat.id, false);
                        }}
                        className="px-2 py-1 rounded-lg border"
                      >
                        deseleziona
                      </button>
                      <span>â–¾</span>
                    </div>
                  </button>

                  {!collapsed[cat.id] && !isEmptyByFilter && (
                    <ul className="divide-y bg-white border rounded-2xl mt-2 overflow-hidden">
                      {list.map((item) => (
                        <li key={item.id} className="p-3 flex items-center gap-3">
                          <button
                            onClick={() => toggleItem(item.id)}
                            className={
                              "w-6 h-6 rounded-lg border flex items-center justify-center " +
                              (item.checked ? "bg-black text-white" : "bg-white")
                            }
                            aria-label="Seleziona"
                          >
                            {item.checked ? "âœ“" : ""}
                          </button>
                          <div className="flex-1 min-w-0">
                            <div className={"font-medium " + (item.checked ? "line-through text-neutral-400" : "")}>
                              {item.name}
                            </div>
                            <input
                              value={item.note || ""}
                              onChange={(e) => updateNote(item.id, e.target.value)}
                              placeholder="Nota (marca, variante, % grassiâ€¦)"
                              className="mt-1 w-full text-sm px-2 py-1 rounded-lg border bg-white"
                            />
                          </div>
                          <div className="flex items-center gap-2">
                            <button onClick={() => updateQty(item.id, -1)} className="px-2 py-1 rounded-lg border">-</button>
                            <span className="w-8 text-center">{item.qty || 1}</span>
                            <button onClick={() => updateQty(item.id, +1)} className="px-2 py-1 rounded-lg border">+</button>
                          </div>
                        </li>
                      ))}
                    </ul>
                  )}
                  {!collapsed[cat.id] && isEmptyByFilter && (
                    <div className="mt-2 px-4 py-6 text-sm text-neutral-500 text-center">
                      Nessun elemento da mostrare.
                    </div>
                  )}
                </section>
              );
            })}

            <div className="h-24"></div>
          </main>

          <footer className="fixed bottom-0 inset-x-0 border-t bg-white">
            <div className="max-w-3xl mx-auto px-4 py-2 flex items-center gap-3">
              <div className="text-sm text-neutral-600">
                Da prendere: <span className="font-semibold">{stats.left}</span> / Totale: {stats.total}
              </div>
              <div className="ml-auto">
                <button onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className="px-3 py-2 rounded-xl border bg-white">
                  Torna su
                </button>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
